function xmlToJson(a,b){var c=true,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++){if(a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1){b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}}}if(a.nodeType===Node.TEXT_NODE){c=a.nodeValue.replace(/^\s+|\s+$/g,"")}else{if(a.nodeType===1){if(a.attributes.length>0){var e;c={};for(d=0;d<a.attributes.length;d++){e=a.attributes.item(d);c[e.nodeName.replaceArray(b,"").toCamel()]=e.nodeValue}}}if(a.hasChildNodes()){var f,g,h;if(c===true){c={}}for(d=0;d<a.childNodes.length;d++){h=a.childNodes.item(d);f=h.nodeType===3?"value":h.nodeName.replaceArray(b,"").toCamel();g=xmlToJson(h,b);if(g.length!=0&&f!="#comment"){if(c.hasOwnProperty(f)){if(h.nodeType===3){c[f]+=g}else{if(c[f].constructor!==Array){c[f]=[c[f]]}c[f].push(g)}}else if(h.nodeType!==3||g!==""){c[f]=g}}}}}return c}function objectToArray(a){if(a==undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function loadXMLDoc(a){xhttp=new XMLHttpRequest;xhttp.open("GET",a,false);xhttp.send();return xhttp.responseXML}function getAttributeByLanguage(a){var b=[];for(var c=0;c<a.length;c++){if(!a[c].lang||a[c].lang&&a[c].lang==tap.language){b.push(a[c])}}if(b.length==0){b=a}return b}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++){c=c.replace(a[d],b)}return c};String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})};var TapTourModel=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}});var TapTourCollection=Backbone.Collection.extend({model:TapTourModel,localStorage:new Store("tours"),selectTour:function(a){tap.currentTour=a;if(tap.tours.get(a).get("rootStopRef")){tap.currentStop=tap.tours.get(a).get("rootStopRef").id}tap.tourStops=new TapStopCollection(null,a);tap.tourAssets=new TapAssetCollection(null,a);tap.tourStops.fetch();tap.tourAssets.fetch()}});var TapStopModel=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}});var TapStopCollection=Backbone.Collection.extend({model:TapStopModel,initialize:function(a,b){this.localStorage=new Store(b+"-stop")},getStopByKeycode:function(a){for(var b=0;b<this.models.length;b++){if(this.models[b].get("propertySet")){for(var c=0;c<this.models[b].get("propertySet").length;c++){if(this.models[b].get("propertySet")[c].name=="code"&&this.models[b].get("propertySet")[c].value==a)return this.models[b].id}}}return false}});var TapAssetModel=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"propertySet":case"source":case"content":return getAttributeByLanguage(objectToArray(this.attributes[a]));default:return this.attributes[a]}}});var TapAssetCollection=Backbone.Collection.extend({model:TapAssetModel,initialize:function(a,b){this.localStorage=new Store(b+"-asset")}});if(!tap){var tap={};tap.tours={};tap.tourAssets={};tap.tourStops={};tap.language="en";tap.currentStop="";tap.currentTour="";_.extend(tap,Backbone.Events);tap.initApp=function(){tap.trigger("tap.init.start");tap.tours=new TapTourCollection;tap.tours.fetch();if(!tap.tours.length){var a=xmlToJson(loadXMLDoc(tap.url));if(a.tour){tap.initModels(a.tour)}else if(a.tourSet&&a.tourSet.tourRef){for(var b=0;b<a.tourSet.tourRef.length;b++){var c=xmlToJson(loadXMLDoc(a.tourSet.tourRef[b].uri));tap.initModels(c.tour)}}else if(a.tourSet&&a.tourSet.tour){for(var b=0;b<a.tourSet.tour.length;b++){tap.initModels(a.tourSet.tour[b])}}}tap.trigger("tap.init.end")};tap.initModels=function(a){tap.tours.create({id:a.id,appResource:objectToArray(a.appResource),connection:objectToArray(a.connection),description:objectToArray(a.description),lastModified:a.lastModified,propertySet:objectToArray(a.propertySet.property),publishDate:objectToArray(a.publishDate),rootStopRef:objectToArray(a.rootStopRef),title:objectToArray(a.title)});var b=new TapStopCollection(null,a.id);for(var c=0;c<a.stop.length;c++){var d=[];for(var e=0;e<a.connection.length;e++){if(a.connection[e].srcId==a.stop[c].id){d.push({priority:a.connection[e].priority,destId:a.connection[e].destId})}}b.create({id:a.stop[c].id,connection:d,view:a.stop[c].view,description:objectToArray(a.stop[c].description),propertySet:a.stop[c].propertySet?objectToArray(a.stop[c].propertySet.property):undefined,assetRef:objectToArray(a.stop[c].assetRef),title:objectToArray(a.stop[c].title)})}var f=new TapAssetCollection(null,a.id);for(var c=0;c<a.asset.length;c++){if(a.asset[c].source&&a.asset[c].source){var g=[];for(var e=0;e<a.asset[c].source.length;e++){if(a.asset[c].source[e].propertySet){a.asset[c].source[e].propertySet=a.asset[c].source[e].propertySet.property}}}f.create({assetRights:objectToArray(a.asset[c].assetRights),content:objectToArray(a.asset[c].content),id:a.asset[c].id,source:objectToArray(a.asset[c].source),propertySet:a.asset[c].propertySet?objectToArray(a.asset[c].propertySet.property):undefined})}b.reset();f.reset()}}