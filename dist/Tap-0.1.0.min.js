/*
 * TAP - v0.1.0 - 2012-05-08
 * http://tapintomuseums.org/
 * Copyright (c) 2011-2012 Indianapolis Museum of Art
 * GPLv3
 */
function getAttributeByLanguage(a){var b=[];for(var c=0;c<a.length;c++)(!a[c].lang||a[c].lang&&a[c].lang==tap.language)&&b.push(a[c]);return b.length===0&&(b=a),b}function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function objectToArray(a){if(a===undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}if(a.nodeType===Node.TEXT_NODE)c=a.nodeValue.replace(/^\s+|\s+$/g,"");else{if(a.nodeType===1&&a.attributes.length>0){var e;c={};for(d=0;d<a.attributes.length;d++)e=a.attributes.item(d),c[e.nodeName.replaceArray(b,"").toCamel()]=e.nodeValue}if(a.hasChildNodes()){var f,g,h;c===!0&&(c={});for(d=0;d<a.childNodes.length;d++){h=a.childNodes.item(d),f=h.nodeType===3?"value":h.nodeName.replaceArray(b,"").toCamel(),g=xmlToJson(h,b);if(g.length!==0&&f!=="#comment")if(c.hasOwnProperty(f))h.nodeType===3?c[f]+=g:(c[f].constructor!==Array&&(c[f]=[c[f]]),c[f].push(g));else if(h.nodeType!==3||g!=="")c[f]=g}}}return c}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},TapAssetModel=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"source":case"content":return getAttributeByLanguage(objectToArray(this.attributes[a]));default:return this.attributes[a]}}}),TapStopModel=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}}),TapTourModel=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}}),TapAssetCollection=Backbone.Collection.extend({model:TapAssetModel,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-asset")}}),TapStopCollection=Backbone.Collection.extend({model:TapStopModel,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-stop")},getStopByKeycode:function(a){for(var b=0;b<this.models.length;b++)if(this.models[b].get("propertySet"))for(var c=0;c<this.models[b].get("propertySet").length;c++)if(this.models[b].get("propertySet")[c].name=="code"&&this.models[b].get("propertySet")[c].value==a)return this.models[b];return!1}}),TapTourCollection=Backbone.Collection.extend({model:TapTourModel,localStorage:new Backbone.LocalStorage("tours"),selectTour:function(a){tap.currentTour=a,tap.tours.get(a).get("rootStopRef")&&(tap.currentStop=tap.tours.get(a).get("rootStopRef").id),tap.tourStops=new TapStopCollection(null,a),tap.tourAssets=new TapAssetCollection(null,a),tap.tourStops.fetch(),tap.tourAssets.fetch()}}),Backbone.View.prototype.close=function(){document.getElementById("audioPlayer")&&document.getElementById("audioPlayer").pause(),document.getElementById("videoPlayer")&&document.getElementById("videoPlayer").pause(),this.$el.empty().undelegate(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},jQuery(function(){window.TourStopAudioView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-audio-tpl").html()),render:function(){var a,b,c;return $stop.attributes.assetRef&&_.each($stop.get("assetRef"),function(d){var e=tap.tourAssets.get(d.id),f=e.get("source");_.each(f,function(d){switch(d.format){case"audio/mp3":case"audio/mpeg":a=d.uri;break;case"audio/ogg":b=d.uri;break;case"audio/wav":c=d.uri}})}),this.$el.html(this.template({tourStopMp3Audio:a,tourStopOggAudio:b,tourStopWavAudio:c,tourStopTitle:$stop.attributes.title[0].value})),this}})}),jQuery(function(){window.TourStopView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-tpl").html()),render:function(){return this.$el.html(this.template({tourStopTitle:$stop.get("title")?$stop.get("title")[0].value:undefined,tourStopDescription:$stop.get("description")?$stop.get("description")[0].value:undefined})),this}})}),jQuery(function(){window.TourStopGalleryView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-gallery-tpl").html()),render:function(){this.$el.html(this.template({tourStopTitle:$stop.attributes.title[0].value}));var a=$("#Gallery a").photoSwipe({enableMouseWheel:!1,enableKeyboard:!0,doubleTapZoomLevel:0,captionAndToolbarOpacity:.8,minUserZoom:0,jQueryMobile:!0});return this}})}),jQuery(function(){window.TourStopGeoView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-geo-tpl").html()),render:function(){return $(this.el).html(this.template({tourStopTitle:$stop.attributes.title[0].value})),this}})}),jQuery(function(){window.TourStopImageView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-image-tpl").html()),render:function(){var a,b;$stop.attributes.assetRef&&$.each($stop.attributes.assetRef,function(){$assetItem=tap.tourAssets.models;for(var c=0;c<$assetItem.length;c++)$assetItem[c].get("id")==this.id&&(this.usage=="primary"||this.usage=="tour_image")&&(a=$assetItem[c].attributes.source[0].uri),$assetItem[c].get("id")==this.id&&this.usage=="icon"&&(b=$assetItem[c].attributes.source[0].uri)}),this.$el.html(this.template({tourImageUri:a,tourIconUri:b,tourStopTitle:$stop.attributes.title[0].value}));var c=$("#soloImage a").photoSwipe({enableMouseWheel:!1,enableKeyboard:!0,doubleTapZoomLevel:0,captionAndToolbarOpacity:.8,minUserZoom:0,preventSlideshow:!0,jQueryMobile:!0});return this}})}),jQuery(function(){window.TourKeypadView=Backbone.View.extend({el:$("#tour-keypad").find(":jqmData(role='content')"),template:_.template($("#tour-keypad-tpl").html()),events:{"tap #gobtn":"submit","tap #keypad div button":"writekeycode","tap #delete":"clearkeycode"},submit:function(){if(!$("#write").html())return;if(!tap.tourStops.getStopByKeycode($("#write").html())){$.mobile.changePage("#error_invalidCode","pop",!0,!0),$("#write").html("");return}$destUrl="#tourstop/"+this.options+"/"+$("#write").html(),Backbone.history.navigate($destUrl,!0)},writekeycode:function(a){$("#write").html($("#write").html()+$(a.currentTarget).html())},clearkeycode:function(a){$("#write").html("")},render:function(){return this.$el.html(this.template({})),this}})}),jQuery(function(){window.TourStopObjectView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-object-tpl").html()),render:function(){return $(this.el).html(this.template({tourStopTitle:$stop.attributes.title[0].value})),this}})}),jQuery(function(){window.TourDetailedView=Backbone.View.extend({el:$("#tour-details").find(":jqmData(role='content')"),template:_.template($("#tour-details-tpl").html()),render:function(){var a=tap.tours.get(tap.currentTour);return $(this.el).html(this.template({publishDate:a.get("publishDate")?a.get("publishDate")[0].value:undefined,description:a.get("description")?a.get("description")[0].value:undefined,stopCount:tap.tourStops.length,assetCount:tap.tourAssets.length})),this}})}),jQuery(function(){window.TourListView=Backbone.View.extend({el:$("#tour-list"),initialize:function(){this.$el.empty(),this.model.bind("reset",this.render)},render:function(a){_.each(this.model.models,function(a){$(this.el).append((new TourListItemView({model:a})).render().el)},this),$(this.el).listview("refresh")}}),window.TourListItemView=Backbone.View.extend({tagName:"li",template:_.template($("#tour-list-item-tpl").html()),render:function(){return $(this.el).html(this.template({title:this.model.get("title")?this.model.get("title")[0].value:undefined,id:this.model.get("id")})),this}})}),jQuery(function(){window.TourStopVideoView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-video-tpl").html()),render:function(){var a,b;return $stop.attributes.assetRef&&_.each($stop.get("assetRef"),function(a){var c=tap.tourAssets.get(a.id),d=c.get("source");_.each(d,function(a){switch(a.format){case"video/mp4":mp4VideoUri=a.uri;break;case"video/ogg":b=a.uri}})}),this.$el.html(this.template({tourStopTitle:$stop.attributes.title[0].value,tourStopMp4Video:mp4VideoUri,tourStopOggVideo:b})),this}})}),jQuery(function(){window.TourStopWebView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-web-tpl").html()),render:function(){return $(this.el).html(this.template({tourStopTitle:$stop.attributes.title[0].value})),this}})}),jQuery(function(){AppRouter=Backbone.Router.extend({routes:{"":"list","tour/:id":"tourDetails","tourkeypad/:id":"tourKeypad","tourstop/:id/:keycode":"tourStop"},bookmarkMode:!1,showView:function(a,b){return tap.currentView&&tap.currentView.close(),$(a).html(b.render().el),tap.currentView=b,b},list:function(){$.mobile.changePage("#tours",{transition:"fade",reverse:!0,changeHash:!1}),this.tourListView=new TourListView({model:tap.tours}),tap.currentView=this.tourListView,this.tourListView.render()},tourDetails:function(a){tap.tours.selectTour(a),$.mobile.changePage("#tour-details",{transition:"fade",reverse:!1,changeHash:!1}),$("#tour-details #page-title").html(tap.tours.get(tap.currentTour).get("title")[0].value),$("#tour-details #start-tour-id").attr("href","#tourkeypad/"+a),this.tourDetailedView=new TourDetailedView,app.showView("#content",this.tourDetailedView)},tourKeypad:function(a){tap.tours.selectTour(a),$.mobile.changePage("#tour-keypad",{transition:"fade",reverse:!1,changeHash:!1}),$("#tour-details #page-title").html(tap.tours.get(tap.currentTour).get("title")[0].value),this.tourKeypadView=new TourKeypadView(a),app.showView("#content",this.tourKeypadView)},tourStop:function(a,b){tap.tours.selectTour(a),$.mobile.changePage("#tour-stop",{transition:"fade",reverse:!1,changeHash:!1}),$("#tour-stop #page-title").html(tap.tours.get(tap.currentTour).get("title")[0].value),$stop=tap.tourStops.getStopByKeycode(b);switch($stop.attributes.view){case"StopGroup":case"tour_stop_group":this.tourStopView=new TourStopView,app.showView("#content",this.tourStopView);return;case"ImageStop":case"tour_image_stop":this.tourStopImageView=new TourStopImageView,app.showView("#content",this.tourStopImageView);return;case"GalleryStop":this.tourStopGalleryView=new TourStopGalleryView,app.showView("#content",this.tourStopGalleryView);return;case"VideoStop":case"tour_video_stop":this.tourStopVideoView=new TourStopVideoView,app.showView("#content",this.tourStopVideoView);return;case"AudioStop":case"tour_audio_stop":this.tourStopAudioView=new TourStopAudioView,app.showView("#content",this.tourStopAudioView);return;case"WebStop":this.tourStopWebView=new TourStopWebView,app.showView("#content",this.tourStopWebView);return;case"ObjectStop":this.tourStopObjectView=new TourStopObjectView,app.showView("#content",this.tourStopObjectView);return;case"GeoStop":this.tourStopGeoView=new TourStopGeoView,app.showView("#content",this.tourStopGeoView);return;default:this.tourStopView=new TourStopView,app.showView("#content",this.tourStopView);return}}})});if(!tap){var tap={};tap.tours={},tap.tourAssets={},tap.tourStops={},tap.language="en",tap.currentStop="",tap.currentTour="",_.extend(tap,Backbone.Events),tap.initApp=function(){tap.trigger("tap.init.start"),tap.tours=new TapTourCollection,tap.tours.fetch();if(!tap.tours.length){var a=xmlToJson(loadXMLDoc(tap.url)),b,c;if(a.tour)tap.initModels(a.tour);else if(a.tourSet&&a.tourSet.tourRef){c=a.tourSet.tourRef.length;for(b=0;b<c;b++){var d=xmlToJson(loadXMLDoc(a.tourSet.tourRef[b].uri));tap.initModels(d.tour)}}else if(a.tourSet&&a.tourSet.tour){c=a.tourSet.tour.length;for(b=0;b<c;b++)tap.initModels(a.tourSet.tour[b])}}tap.trigger("tap.init.end")},tap.initModels=function(a){tap.tours.create({id:a.id,appResource:a.tourMetadata&&a.tourMetadata.appResource?objectToArray(a.tourMetadata.appResource):undefined,connection:objectToArray(a.connection),description:a.tourMetadata&&a.tourMetadata.description?objectToArray(a.tourMetadata.description):undefined,lastModified:a.tourMetadata&&a.tourMetadata.lastModified?a.tourMetadata.lastModified:undefined,propertySet:a.tourMetadata&&a.tourMetadata.propertySet?objectToArray(a.tourMetadata.property):undefined,publishDate:a.tourMetadata&&a.tourMetadata.publishDate?objectToArray(a.tourMetadata.publishDate):undefined,rootStopRef:a.tourMetadata&&a.tourMetadata.rootStopRef?a.tourMetadata.rootStopRef:undefined,title:a.tourMetadata&&a.tourMetadata.title?objectToArray(a.tourMetadata.title):undefined});var b,c,d=new TapStopCollection(null,a.id),e=a.stop.length;for(b=0;b<e;b++){var f=[],g=a.connection.length;for(c=0;c<g;c++)a.connection[c].srcId==a.stop[b].id&&f.push({priority:a.connection[c].priority,destId:a.connection[c].destId});d.create({id:a.stop[b].id,connection:f,view:a.stop[b].view,description:objectToArray(a.stop[b].description),propertySet:a.stop[b].propertySet?objectToArray(a.stop[b].propertySet.property):undefined,assetRef:objectToArray(a.stop[b].assetRef),title:objectToArray(a.stop[b].title)})}var h=new TapAssetCollection(null,a.id),i=a.asset.length;for(b=0;b<i;b++){if(a.asset[b].source&&a.asset[b].source){var j=[],k=a.asset[b].source.length;for(c=0;c<k;c++)a.asset[b].source[c].propertySet&&(a.asset[b].source[c].propertySet=a.asset[b].source[c].propertySet.property)}h.create({assetRights:objectToArray(a.asset[b].assetRights),content:objectToArray(a.asset[b].content),id:a.asset[b].id,source:objectToArray(a.asset[b].source),propertySet:a.asset[b].propertySet?objectToArray(a.asset[b].propertySet.property):undefined})}d.reset(),h.reset()}};