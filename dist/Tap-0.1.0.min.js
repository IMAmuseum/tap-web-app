/*
 * TAP - v0.1.0 - 2012-05-31
 * http://tapintomuseums.org/
 * Copyright (c) 2011-2012 Indianapolis Museum of Art
 * GPLv3
 */
function getAttributeByLanguage(a){var b=[];for(var c=0;c<a.length;c++)(!a[c].lang||a[c].lang&&a[c].lang==tap.language)&&b.push(a[c]);return b.length===0&&(b=a),b}function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function objectToArray(a){if(a===undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}var e=!0;if(a.attributes&&a.attributes.length>0){var f;e={};for(var g=0;g<a.attributes.length;g++)f=a.attributes.item(g),e[f.nodeName.replaceArray(b,"").toCamel()]=f.nodeValue}if(a.hasChildNodes()){var h,i,j;e===!0&&(e={});for(var k=0;k<a.childNodes.length;k++){j=a.childNodes.item(k);if((j.nodeType&7)===1)h=j.nodeName.replaceArray(b,"").toCamel(),i=xmlToJson(j,b),e.hasOwnProperty(h)?(e[h].constructor!==Array&&(e[h]=[e[h]]),e[h].push(i)):e[h]=i;else if((j.nodeType-1|1)===3){h="value",i=j.nodeType===3?j.nodeValue.replace(/^\s+|\s+$/g,""):j.nodeValue;if(e.hasOwnProperty(h))e[h]+=i;else if(j.nodeType===4||i!=="")e[h]=i}}}return e}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Asset=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"source":case"content":return getAttributeByLanguage(objectToArray(this.attributes[a]));default:return this.attributes[a]}}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Stop=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Tour=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Assets=Backbone.Collection.extend({model:TapAPI.models.Asset,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-asset")}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Stops=Backbone.Collection.extend({model:TapAPI.models.Stop,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-stop")},getStopByKeycode:function(a){for(var b=0;b<this.models.length;b++)if(this.models[b].get("propertySet"))for(var c=0;c<this.models[b].get("propertySet").length;c++)if(this.models[b].get("propertySet")[c].name=="code"&&this.models[b].get("propertySet")[c].value==a)return this.models[b];return!1}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Tours=Backbone.Collection.extend({model:TapAPI.models.Tour,localStorage:new Backbone.LocalStorage("tours"),selectTour:function(a){tap.currentTour=a,tap.tours.get(a).get("rootStopRef")&&(tap.currentStop=tap.tours.get(a).get("rootStopRef").id),tap.tourStops=new TapAPI.collections.Stops(null,a),tap.tourAssets=new TapAPI.collections.Assets(null,a),tap.tourStops.fetch(),tap.tourAssets.fetch()}}),Backbone.View.prototype.close=function(){document.getElementById("audioPlayer")&&document.getElementById("audioPlayer").pause(),document.getElementById("videoPlayer")&&document.getElementById("videoPlayer").pause(),this.$el.empty().undelegate(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_audio_stop="AudioStop",TapAPI.views.registry.AudioStop="AudioStop",jQuery(function(){TapAPI.views.AudioStop=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("audio-stop"),render:function(){var a,b,c,d=tap.currentStop.get("assetRef");return d&&_.each(d,function(d){var e=tap.tourAssets.get(d.id),f=e.get("source");_.each(f,function(d){switch(d.format){case"audio/mp3":case"audio/mpeg":a=d.uri;break;case"audio/ogg":b=d.uri;break;case"audio/wav":c=d.uri}})}),this.$el.html(this.template({tourStopMp3Audio:a,tourStopOggAudio:b,tourStopWavAudio:c,tourStopTitle:tap.currentStop.get("title")[0].value})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Stop=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("stop"),render:function(){return this.$el.html(this.template({tourStopTitle:tap.currentStop.get("title")?tap.currentStop.get("title")[0].value:undefined,tourStopDescription:tap.currentStop.get("description")?tap.currentStop.get("description")[0].value:undefined})),this}})}),jQuery(function(){window.TourStopGalleryView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-gallery-tpl").html()),render:function(){this.$el.html(this.template({tourStopTitle:tap.currentStop.get("title")[0].value}));var a=$("#Gallery a").photoSwipe({enableMouseWheel:!1,enableKeyboard:!0,doubleTapZoomLevel:0,captionAndToolbarOpacity:.8,minUserZoom:0,jQueryMobile:!0});return this}})}),jQuery(function(){window.TourStopGeoView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-geo-tpl").html()),render:function(){return $(this.el).html(this.template({tourStopTitle:tap.currentStop.get("title")[0].value})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_image_stop="ImageStop",TapAPI.views.registry.ImageStop="ImageStop",jQuery(function(){TapAPI.views.ImageStop=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("image-stop"),render:function(){var a,b,c=tap.currentStop.get("assetRef");c&&$.each(c,function(){$assetItem=tap.tourAssets.models;for(var c=0;c<$assetItem.length;c++)$assetItem[c].get("id")==this.id&&(this.usage=="primary"||this.usage=="tour_image")&&(a=$assetItem[c].get("source")[0].uri),$assetItem[c].get("id")==this.id&&this.usage=="icon"&&(b=$assetItem[c].get("source")[0].uri)}),this.$el.html(this.template({tourImageUri:a,tourIconUri:b,tourStopTitle:tap.currentStop.get("title")[0].value}));var d=$("#soloImage a").photoSwipe({enableMouseWheel:!1,enableKeyboard:!0,doubleTapZoomLevel:0,captionAndToolbarOpacity:.8,minUserZoom:0,preventSlideshow:!0,jQueryMobile:!0});return this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Keypad=Backbone.View.extend({el:$("#tour-keypad").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("keypad"),events:{"tap #gobtn":"submit","tap #keypad div button":"writekeycode","tap #delete":"clearkeycode"},submit:function(){if(!$("#write").html())return;if(!tap.tourStops.getStopByKeycode($("#write").html())){$.mobile.changePage("#error_invalidCode","pop",!0,!0),$("#write").html("");return}$destUrl="#tourstop/"+tap.currentTour+"/"+$("#write").html(),Backbone.history.navigate($destUrl,!0)},writekeycode:function(a){$("#write").html($("#write").html()+$(a.currentTarget).html())},clearkeycode:function(a){$("#write").html("")},render:function(){return this.$el.html(this.template()),this},close:function(){}})}),jQuery(function(){window.TourStopObjectView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-object-tpl").html()),render:function(){return $(this.el).html(this.template({tourStopTitle:tap.currentStop.get("title")[0].value})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_stop_group="StopGroup",TapAPI.views.registry.StopGroup="StopGroup",jQuery(function(){TapAPI.views.StopGroup=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("stop-group"),render:function(){this.$el.html(this.template({tourStopTitle:getAttributeByLanguage(tap.currentStop.get("title"))[0].value,description:getAttributeByLanguage(tap.currentStop.get("description"))[0].value}));var a=tap.currentStop.get("connection"),b=this.$el.find("#stop-list");return _.each(a,function(a){var c=tap.tourStops.get(a.destId);if(c){var d=new TapAPI.views.StopGroupListItem({model:c});b.append(d.render().$el)}}),b.listview(),this}}),TapAPI.views.StopGroupListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("stop-group-list-item"),render:function(){return this.$el.html(this.template({title:this.model.get("title")?this.model.get("title")[0].value:undefined,id:this.model.get("id"),tourId:tap.currentTour})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.TourDetails=Backbone.View.extend({el:$("#tour-details").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("tour-details"),render:function(){var a=tap.tours.get(tap.currentTour);return $(this.el).html(this.template({publishDate:a.get("publishDate")?a.get("publishDate")[0].value:undefined,description:a.get("description")?a.get("description")[0].value:undefined,stopCount:tap.tourStops.length,assetCount:tap.tourAssets.length})),this}})}),jQuery(function(){window.TourListView=Backbone.View.extend({el:$("#tour-list"),initialize:function(){this.$el.empty(),this.model.bind("reset",this.render)},render:function(a){_.each(this.model.models,function(a){$(this.el).append((new TourListItemView({model:a})).render().el)},this),this.$el.listview("refresh")}}),window.TourListItemView=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("tour-list-item"),render:function(){return $(this.el).html(this.template({title:this.model.get("title")?this.model.get("title")[0].value:undefined,id:this.model.get("id")})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_video_stop="VideoStop",TapAPI.views.registry.VideoStop="VideoStop",jQuery(function(){TapAPI.views.VideoStop=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:TapAPI.templateManager.get("video-stop"),render:function(){var a,b,c=tap.currentStop.get("assetRef");return c&&_.each(c,function(a){var c=tap.tourAssets.get(a.id),d=c.get("source");_.each(d,function(a){switch(a.format){case"video/mp4":mp4VideoUri=a.uri;break;case"video/ogg":b=a.uri}})}),this.$el.html(this.template({tourStopTitle:tap.currentStop.get("title")[0].value,tourStopMp4Video:mp4VideoUri,tourStopOggVideo:b})),this}})}),jQuery(function(){window.TourStopWebView=Backbone.View.extend({el:$("#tour-stop").find(":jqmData(role='content')"),template:_.template($("#tour-stop-web-tpl").html()),render:function(){return $(this.el).html(this.template({tourStopTitle:tap.currentStop.get("title")[0].value})),this}})}),jQuery(function(){AppRouter=Backbone.Router.extend({views:{},routes:{"":"list","tour/:id":"tourDetails","tourkeypad/:id":"tourKeypad","tourstop/:id/:keycode":"tourStop"},bookmarkMode:!1,showView:function(a,b){return tap.currentView&&tap.currentView.close(),this.views[b]==undefined&&(this.views[b]=new TapAPI.views[b]),$(a).html(this.views[b].render().el),tap.currentView=this.views[b],tap.currentView},list:function(){$.mobile.changePage("#tours",{transition:"fade",reverse:!0,changeHash:!1}),this.tourListView=new TourListView({model:tap.tours}),tap.currentView=this.tourListView,this.tourListView.render()},tourDetails:function(a){tap.tours.selectTour(a),$.mobile.changePage("#tour-details",{transition:"fade",reverse:!1,changeHash:!1}),$("#tour-details #page-title").html(tap.tours.get(tap.currentTour).get("title")[0].value),$("#tour-details #start-tour-id").attr("href","#tourkeypad/"+a),this.showView("#content","TourDetails")},tourKeypad:function(a){tap.tours.selectTour(a),$.mobile.changePage("#tour-keypad",{transition:"fade",reverse:!1,changeHash:!1}),$("#tour-details #page-title").html(tap.tours.get(tap.currentTour).get("title")[0].value),this.showView("#content","Keypad")},tourStop:function(a,b){tap.tours.selectTour(a),$.mobile.changePage("#tour-stop",{transition:"fade",reverse:!1,changeHash:!1}),$("#tour-stop #page-title").html(tap.tours.get(tap.currentTour).get("title")[0].value),tap.currentStop=tap.tourStops.getStopByKeycode(b);var c=TapAPI.views.registry[tap.currentStop.get("view")];c!=undefined?this.showView("#content",c):(console.log("View not in registry: ",tap.currentStop.get("view")),this.showView("#content","Stop"))}})});if(!tap){var tap={};tap.tours={},tap.tourAssets={},tap.tourStops={},tap.language="en",tap.currentStop="",tap.currentTour="",_.extend(tap,Backbone.Events),tap.initApp=function(a){tap.url=a,tap.trigger("tap.init.start"),tap.tours=new TapAPI.collections.Tours,tap.tours.fetch();if(!tap.tours.length){var b=xmlToJson(loadXMLDoc(tap.url)),c,d;if(b.tour)tap.initModels(b.tour);else if(b.tourSet&&b.tourSet.tourRef){d=b.tourSet.tourRef.length;for(c=0;c<d;c++){var e=xmlToJson(loadXMLDoc(b.tourSet.tourRef[c].uri));tap.initModels(e.tour)}}else if(b.tourSet&&b.tourSet.tour){d=b.tourSet.tour.length;for(c=0;c<d;c++)tap.initModels(b.tourSet.tour[c])}}tap.trigger("tap.init.end"),tap.router=new AppRouter},tap.initModels=function(a){tap.tours.create({id:a.id,appResource:a.tourMetadata&&a.tourMetadata.appResource?objectToArray(a.tourMetadata.appResource):undefined,connection:objectToArray(a.connection),description:a.tourMetadata&&a.tourMetadata.description?objectToArray(a.tourMetadata.description):undefined,lastModified:a.tourMetadata&&a.tourMetadata.lastModified?a.tourMetadata.lastModified:undefined,propertySet:a.tourMetadata&&a.tourMetadata.propertySet?objectToArray(a.tourMetadata.property):undefined,publishDate:a.tourMetadata&&a.tourMetadata.publishDate?objectToArray(a.tourMetadata.publishDate):undefined,rootStopRef:a.tourMetadata&&a.tourMetadata.rootStopRef?a.tourMetadata.rootStopRef:undefined,title:a.tourMetadata&&a.tourMetadata.title?objectToArray(a.tourMetadata.title):undefined});var b,c,d=new TapAPI.collections.Stops(null,a.id),e=a.stop.length;for(b=0;b<e;b++){var f=[],g=a.connection.length;for(c=0;c<g;c++)a.connection[c].srcId==a.stop[b].id&&f.push({priority:a.connection[c].priority,destId:a.connection[c].destId});d.create({id:a.stop[b].id,connection:f,view:a.stop[b].view,description:objectToArray(a.stop[b].description),propertySet:a.stop[b].propertySet?objectToArray(a.stop[b].propertySet.property):undefined,assetRef:objectToArray(a.stop[b].assetRef),title:objectToArray(a.stop[b].title)})}var h=new TapAPI.collections.Assets(null,a.id),i=a.asset.length;for(b=0;b<i;b++){if(a.asset[b].source&&a.asset[b].source){var j=[],k=a.asset[b].source.length;for(c=0;c<k;c++)a.asset[b].source[c].propertySet&&(a.asset[b].source[c].propertySet=a.asset[b].source[c].propertySet.property)}h.create({assetRights:objectToArray(a.asset[b].assetRights),content:objectToArray(a.asset[b].content),id:a.asset[b].id,source:objectToArray(a.asset[b].source),propertySet:a.asset[b].propertySet?objectToArray(a.asset[b].propertySet.property):undefined})}d.reset(),h.reset()}}typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.templates=="undefined"&&(TapAPI.templates={}),TapAPI.templateManager={get:function(a){return TapAPI.templates[a]===undefined&&$.ajax({async:!1,dataType:"html",url:"js/backbone/templates/"+a+".tpl.html",success:function(b,c,d){TapAPI.templates[a]=_.template(b)}}),TapAPI.templates[a]}},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.templates=="undefined"&&(TapAPI.templates={}),TapAPI.templates["audio-stop"]=undefined,TapAPI.templates["image-stop"]=undefined,TapAPI.templates.keypad=undefined,TapAPI.templates["stop-group-list-item"]=undefined,TapAPI.templates["stop-group"]=undefined,TapAPI.templates.stop=undefined,TapAPI.templates["tour-details"]=undefined,TapAPI.templates["tour-list-item"]=undefined,TapAPI.templates["video-stop"]=undefined;